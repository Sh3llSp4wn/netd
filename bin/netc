#!/usr/bin/env ruby
# frozen_string_literal: true

require 'netd_core'
require 'logger'
require 'zlib'
require 'base64'

require 'dry/cli'
require 'awesome_print'

module NetC
  # convention for dry/cli
  module Command
    # required to implement a cli command
    extend Dry::CLI::Registry

    # install the service file
    class Install < Dry::CLI::Command
      desc 'Install service file to systemd user directory'
      def call(**)
        service_file_data = 'eJwljLEKgzAURfd8RZaueUJnl2KHLl1EOohDjFcNvMby8pT69xW7He65nLZJUT' \
                            'tTIQeJH41LKpsMsYwNbA/aYoAdF7FPaGVMW/+nzty/CLV60ZLWLNTHRLL2u73M5HgJninPXkAT3qegqy' \
                            'tccf4SdDhSj5TVM3fm5ZNiuO3lgNGvrO7ITlDzAyzzNxM='
        service_file = Zlib::Inflate.inflate(Base64.decode64(service_file_data))
        fname = "#{Dir.home}/.config/systemd/user/netd.service"
        File.write(fname, service_file)
        puts "Wrote service file to #{fname}"
        puts "To enable the service, execute the following:\n"
        puts 'systemctl --user enable netd.service'
        puts 'systemctl --user start netd.service'
      end
    end

    # list current forwards
    class List < Dry::CLI::Command
      # list current forwards
      desc 'List the currently registered port forwards'
      def call(**)
        NetDSvr.connect_to_netd do |socket|
          socket.puts 'list|'
          NetDSvr.parse_list socket
        end
      end
    end

    module PortFwd
      # Local port forward
      class Local < Dry::CLI::Command
        desc 'Create a new local port forward'
        option :host, type: :String, default: '127.0.0.1', desc: 'Host address to bind to', required: true
        option :bind, type: :String, default: '127.0.0.1:8000', desc: 'Host address to bind to in <ip>:<port> format'
        option :remote, type: :String, desc: 'Remote address to connect to'

        def call(host:, bind:, remote:, **)
          bind_addr, bind_port = bind.split(':')
          remote_addr, remote_port = remote.split(':')
          NetDSvr.connect_to_netd do |socket|
            socket.puts NetD::OperationRequest.local_port_forward(
              host,
              bind_port.to_i, bind_addr,
              remote_port.to_i, remote_addr
            )
            puts socket.readline
          end
        end
      end

      # Remote port forward
      class Remote < Dry::CLI::Command
        desc 'Create a new remote port forward'
        option :host, type: :String, default: '127.0.0.1', desc: 'Host address to bind to', required: true
        option :bind, type: :String, default: '127.0.0.1:8000', desc: 'Remote address to bind to in <ip>:<port> format'
        option :local, type: :String, desc: 'Local address to connect to'

        def call(host:, bind:, local:, **)
          bind_addr, bind_port = bind.split(':')
          local_addr, local_port = local.split(':')
          NetDSvr.connect_to_netd do |socket|
            socket.puts NetD::OperationRequest.remote_port_forward(
              host,
              bind_port.to_i, bind_addr,
              local_port.to_i, local_addr
            )
            puts socket.readline
          end
        end
      end
    end
    register 'install', Install
    register 'list', List
    register 'pfwd', aliases: ['p'] do |prefix|
      prefix.register 'local', PortFwd::Local
      prefix.register 'remote', PortFwd::Remote
    end
  end
end

def main
  Dry::CLI.new(NetC::Command).call
end

main
